!function(m,x,b){"use strict";var D="ht",M=m[D],S=M.Default,B=S.def,I=S.getInternal();M.HistoryManager=function(J){this._histories=[],this.setDataModel(J)},B(M.HistoryManager,x,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var b=this;b._betweenTransaction++,1===b._betweenTransaction&&(b._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var K=this,h=K._histories;if(K._betweenTransaction>0&&K._betweenTransaction--,0===K._betweenTransaction){if(K._transactionHistories){var s=[];for(var U in K._transactionHistories)s.push(K._transactionHistories[U]);s.length&&(h=h.slice(0,K._historyIndex+1),h.push(s),h.length>K._maxHistoryCount&&(h=h.slice(h.length-K._maxHistoryCount)),K.setHistories(h),K.setHistoryIndex(h.length-1,!0))}delete K._transactionHistories}}},setDataModel:function(Q){var r=this,x=r._dataModel;x!==Q&&(x&&(delete x._historyManager,x.ump(r.handleDataModelPropertyChange,r),x.umm(r.$5p,r),x.umd(r.$6p,r),x.removeHierarchyChangeListener(r.handleHierarchyChange,r),x.removeIndexChangeListener(r.handleIndexChange,r)),r._dataModel=Q,Q&&(Q._historyManager=r,Q.mp(r.handleDataModelPropertyChange,r),Q.mm(r.$5p,r),Q.md(r.$6p,r),Q.addHierarchyChangeListener(r.handleHierarchyChange,r),Q.addIndexChangeListener(r.handleIndexChange,r)),r.fp("dataModel",x,Q),r.clear())},setHistoryIndex:function($,R){var E=this,A=E._historyIndex,d=E._histories.length;if(-1>$?$=-1:$>=d&&($=d-1),A!==$){if(!R){var j=$-A;j>0?E.$2p(j):0>j&&E.$1p(-j)}E._historyIndex=$,E.fp("historyIndex",A,$),E.dataModel&&E.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(g){var M=this,h=M._histories,P=M._maxHistoryCount;(!g||0>=g)&&(g=10),P!==g&&(M._maxHistoryCount=g,M.fp("maxHistoryCount",P,g),h.length>g&&M.clear())},cloneValue:function(r){return M.Default.clone(r)},isPropertyUndoable:function(h){return h&&!this.ignoredPropertyMap[h]},isIndexUndoable:function(){return!1},isDataModelPropertyUndoable:function(f){return f&&!this.ignoreDataModelPropertyMap[f]},$5p:function(c){this.handleChange(c,c.kind)},$6p:function(p){this.handleChange(p,"property")},handleHierarchyChange:function(t){this.handleChange(t,"hierarchy")},handleIndexChange:function(N){this.handleChange(N,"index")},handleDataModelPropertyChange:function(_){this.handleChange(_,"dataModelProperty")},toChildrenInfo:function(a){var o={};return o.data=a,o.children=[],a.eachChild(function(G){o.children.push(this.toChildrenInfo(G))},this),o},restoreChildren:function(f){var T=f.data;f.children.forEach(function(B){var f=B.data;f.getParent()!==T&&T.addChild(f),this._dataModel.contains(f)||this._dataModel.add(f),this.restoreChildren(B)},this)},handleChange:function(y,v){var f=this;if(!(f._disabled||f._isUndoRedoing||S.loadingRefGraph)){var j,d=(f._histories,y.data),s=y.property;if(!d||!(d._refGraph||d instanceof M.RefGraph)){if("property"===v)f.isPropertyUndoable(s,d)&&(j={kind:v,data:d,property:s,oldValue:f.cloneValue(y.oldValue,d,s),newValue:f.cloneValue(y.newValue,d,s),event:y});else if("hierarchy"===v||"index"===v&&f.isIndexUndoable(y))j={kind:v,data:d,oldIndex:y.oldIndex,newIndex:y.newIndex,event:y};else if("clear"===v)j={kind:v,json:y.json,event:y};else if("add"===v){if(j={kind:v,data:d,event:y,childrenInfo:this.toChildrenInfo(d),parent:d.getParent()},j.parent){var n=f._dataModel.getSiblings(d);j.siblingsIndex=n.indexOf(d)}d instanceof M.Node&&(j.host=d.getHost(),j.attaches=d.getAttaches()?d.getAttaches().toArray():b),d instanceof M.Edge&&(j.source=d.getSource(),j.target=d.getTarget())}else"remove"===v?j={kind:v,data:d,event:y}:"dataModelProperty"===v&&f.isDataModelPropertyUndoable(s,d)&&(j={kind:v,property:s,oldValue:f.cloneValue(y.oldValue,d,s),newValue:f.cloneValue(y.newValue,d,s),event:y});f.addHistory(j)}}},addHistory:function(l){var m=this;if(l)if(m._betweenTransaction){var q=(l.data?l.data._id:0)+"_"+l.kind+"_"+l.property;if("property"===l.kind||"dataModelProperty"===l.kind){var D=m._transactionHistories[q];D&&(l.oldValue=D.oldValue)}m._transactionHistories[q]=l}else{var n=m._histories;n=n.slice(0,m._historyIndex+1),n.push([l]),n.length>m._maxHistoryCount&&(n=n.slice(n.length-m._maxHistoryCount)),m.setHistories(n),m.setHistoryIndex(n.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(P){(!P||0>=P)&&(P=1),this.setHistoryIndex(this._historyIndex-P)},$1p:function(B){if(this.canUndo()){var v,s=this,l=s._dataModel,X=s._histories,g=s._historyIndex,p=0;for(s._isUndoRedoing=!0,S.setIsolating(!0);B>0;){if(g>=0&&g<X.length){p++,v=X[g],g--;for(var W=v.length-1;W>=0;W--){var D=v[W],V=D.kind,a=D.data,E=D.property,Z=D.event,G=this.cloneValue(D.oldValue,a,E);if(D.undo)D.undo();else if("add"===V)l.remove(a,{keepChildren:!0});else if("remove"===V)l.contains(a)||l.add(a,Z.rootsIndex,Z.datasIndex);else if("clear"===V)l.deserialize(S.clone(D.json));else if("property"===V)if("parent"===E)G?G.addChild(a,Z.oldIndex):(a.setParent(G),Z.oldIndex>=0&&l.moveTo(a,Z.oldIndex));else{var h=null;0===E.indexOf("a:")?(h="attr",E=E.replace("a:","")):0===E.indexOf("s:")?(h="style",E=E.replace("s:","")):0===E.indexOf("f:")&&(h="field",E=E.replace("f:","")),I.setPropertyValue(a,h,E,G)}else if("dataModelProperty"===V){var h=null;0===E.indexOf("a:")?(h="attr",E=E.replace("a:","")):0===E.indexOf("s:")?(h="style",E=E.replace("s:","")):0===E.indexOf("f:")&&(h="field",E=E.replace("f:","")),I.setPropertyValue(l,h,E,G)}else"hierarchy"===V?l.moveTo(a,D.oldIndex):"index"===V&&l.moveToIndex(a,D.oldIndex)}}B--}S.setIsolating(!1),delete s._isUndoRedoing,s.afterUndo(p)}},afterUndo:function(){},redo:function(b){(!b||0>=b)&&(b=1),this.setHistoryIndex(this._historyIndex+b)},$2p:function(m){if(this.canRedo()){var j,p=this,$=p._dataModel,u=p._histories,v=p._historyIndex,n=0;for(p._isUndoRedoing=!0,S.setIsolating(!0);m>0;){if(v>=-1&&v<u.length-1){n++,v++,j=u[v];for(var Z=0;Z<j.length;Z++){var o=j[Z],y=o.kind,Q=o.data,z=o.property,W=o.event,r=this.cloneValue(o.newValue,Q,z);if(o.redo)o.redo();else if("add"===y)o.parent&&!Q.getParent()&&o.parent.addChild(Q,o.siblingsIndex),$.contains(Q)||$.add(Q,W.rootsIndex,W.datasIndex),this.restoreChildren(o.childrenInfo),Q instanceof M.Node&&(Q.setHost(o.host),o.attaches&&o.attaches.forEach(function(y){y.setHost(Q)})),Q instanceof M.Edge&&(Q.setSource(o.source),Q.setTarget(o.target));else if("remove"===y)$.remove(Q);else if("clear"===y)$.clear();else if("property"===y)if("parent"===z)r?r.addChild(Q,W.newIndex):(Q.setParent(r),W.newIndex>=0&&$.moveTo(Q,W.newIndex));else{var N=null;0===z.indexOf("a:")?(N="attr",z=z.replace("a:","")):0===z.indexOf("s:")?(N="style",z=z.replace("s:","")):0===z.indexOf("f:")&&(N="field",z=z.replace("f:","")),I.setPropertyValue(Q,N,z,r)}else if("dataModelProperty"===y){var N=null;0===z.indexOf("a:")?(N="attr",z=z.replace("a:","")):0===z.indexOf("s:")?(N="style",z=z.replace("s:","")):0===z.indexOf("f:")&&(N="field",z=z.replace("f:","")),I.setPropertyValue($,N,z,r)}else"hierarchy"===y?$.moveTo(Q,o.newIndex):"index"===y&&$.moveToIndex(Q,o.newIndex)}}m--}S.setIsolating(!1),delete p._isUndoRedoing,this.afterRedo(n)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);